<!DOCTYPE html>
<html lang="th">
<%- include('layout/head') %>

    <body class="bg-slate-50 text-slate-800 antialiased min-h-screen flex flex-col">

        <%- include('layout/navbar', { activePage: 'admin' , user: locals.user }) %>

            <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

                <!-- Page Header -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">จัดการและควบคุมระบบ</h1>
                        <p class="text-sm text-slate-500 mt-1">สถิติการทำงานของคลังสินค้า</p>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-slate-200 mb-6">
                    <nav class="flex space-x-1 -mb-px overflow-x-auto">
                        <button
                            class="admin-tab active-tab px-5 py-3 text-sm font-semibold text-emerald-700 border-b-2 border-emerald-600 whitespace-nowrap"
                            data-tab="stats">
                            สถิติการขาย
                        </button>
                        <button
                            class="admin-tab px-5 py-3 text-sm font-medium text-slate-500 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 whitespace-nowrap"
                            data-tab="logs">
                            บันทึกระบบ (System Logs)
                        </button>
                    </nav>
                </div>

                <!-- Tab: Statistics -->
                <div id="tab-stats" class="tab-panel">

                    <!-- Summary Stat Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                            <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider mb-1">
                                สินค้าในคลัง</p>
                            <p id="statTotalProducts" class="text-2xl font-bold text-slate-800">—</p>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                            <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider mb-1">
                                จำนวนสต็อกรวม</p>
                            <p id="statTotalStock" class="text-2xl font-bold text-emerald-600">—</p>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                            <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider mb-1">มูลค่ารวม
                                (บาท)</p>
                            <p id="statTotalValue" class="text-2xl font-bold text-indigo-600">—</p>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                            <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider mb-1">
                                รายการนำเข้าซ้ำ</p>
                            <p id="statTotalReceive" class="text-2xl font-bold text-blue-600">—</p>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                            <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider mb-1">
                                รายการเบิกออก</p>
                            <p id="statTotalWithdraw" class="text-2xl font-bold text-rose-600">—</p>
                        </div>
                    </div>


                    <!-- Dual Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Left: Low Stock -->
                        <div
                            class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div
                                class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-rose-50/30">
                                <h2 class="text-base font-semibold text-rose-800 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-rose-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                        </path>
                                    </svg>
                                    สินค้าที่เหลือน้อย (< 50 ชิ้น) </h2>
                            </div>
                            <div class="overflow-x-auto flex-1">
                                <table class="w-full text-left text-sm">
                                    <thead>
                                        <tr
                                            class="bg-slate-50 text-[11px] text-slate-500 font-semibold uppercase tracking-wider border-b border-slate-100">
                                            <th class="px-5 py-3">รหัส</th>
                                            <th class="px-5 py-3">ชื่อสินค้า</th>
                                            <th class="px-5 py-3 text-right">จำนวนคงเหลือ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbLowStock" class="divide-y divide-slate-100">
                                        <tr>
                                            <td colspan="3" class="px-5 py-6 text-center text-slate-400">กำลังโหลด...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Right: Frequent Access -->
                        <div
                            class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                                <h2 class="text-base font-semibold text-slate-800">สินค้าที่มีการทำรายการบ่อย</h2>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button onclick="toggleFreqTab('receive')" id="btnFreqReceive"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-blue-700 transition duration-150">นำเข้าบ่อย</button>
                                    <button onclick="toggleFreqTab('withdraw')" id="btnFreqWithdraw"
                                        class="px-3 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700 transition duration-150">เบิกออกบ่อย</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto flex-1">
                                <table class="w-full text-left text-sm">
                                    <thead>
                                        <tr
                                            class="bg-slate-50 text-[11px] text-slate-500 font-semibold uppercase tracking-wider border-b border-slate-100">
                                            <th class="px-5 py-3">สินค้า</th>
                                            <th class="px-5 py-3 text-center">ความถี่ (ครั้ง)</th>
                                            <th class="px-5 py-3 text-right">จำนวนรวม</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbFrequent" class="divide-y divide-slate-100">
                                        <tr>
                                            <td colspan="3" class="px-5 py-6 text-center text-slate-400">กำลังโหลด...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Tab: System Logs -->
                <div id="tab-logs" class="tab-panel hidden space-y-8">

                    <!-- Admin/User Management Activity -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                            <h2 class="text-base font-semibold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ประวัติการจัดการระบบ (สร้าง/ลบ สินค้าและผู้ใช้งาน)
                            </h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr
                                        class="bg-white text-xs text-slate-400 font-semibold uppercase tracking-wider border-b border-slate-100">
                                        <th class="px-6 py-3">วัน-เวลา</th>
                                        <th class="px-6 py-3">ประเภท</th>
                                        <th class="px-6 py-3">รายละเอียด</th>
                                        <th class="px-6 py-3">ผู้ดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivity" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="4" class="px-6 py-6 text-center text-slate-400">กำลังโหลด...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

            </main>

            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script>
                const AUTH_USER = { username: "<%= locals.user ? locals.user.username : '' %>", role: "<%= locals.user ? locals.user.role : '' %>" };

                // --- Tab Switching ---
                const tabs = document.querySelectorAll('.admin-tab');
                const panels = document.querySelectorAll('.tab-panel');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => {
                            t.classList.remove('active-tab', 'text-emerald-700', 'border-emerald-600', 'font-semibold');
                            t.classList.add('text-slate-500', 'border-transparent', 'font-medium');
                        });
                        panels.forEach(p => p.classList.add('hidden'));
                        tab.classList.add('active-tab', 'text-emerald-700', 'border-emerald-600', 'font-semibold');
                        tab.classList.remove('text-slate-500', 'border-transparent', 'font-medium');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
                    });
                });

                let statsData = null;
                let currentFreqTab = 'receive';

                async function loadStats() {
                    try {
                        const [statsRes, historyRes] = await Promise.all([
                            fetch('/api/admin/dashboard-stats'),
                            fetch('/api/history')
                        ]);
                        statsData = await statsRes.json();
                        const history = await historyRes.json();

                        // 1. Summary cards
                        document.getElementById('statTotalProducts').textContent = (statsData.totalProducts ?? '—').toLocaleString();
                        document.getElementById('statTotalStock').textContent = (statsData.totalStock ?? '—').toLocaleString();
                        document.getElementById('statTotalValue').textContent = "฿" + (statsData.totalValue ?? '—').toLocaleString(undefined, { minimumFractionDigits: 2 });
                        document.getElementById('statTotalReceive').textContent = (statsData.totalReceiveTx ?? '—').toLocaleString();
                        document.getElementById('statTotalWithdraw').textContent = (statsData.totalWithdrawTx ?? '—').toLocaleString();

                        // 2. Low Stock Table
                        const tbLow = document.getElementById('tbLowStock');
                        if (!statsData.lowStockList || statsData.lowStockList.length === 0) {
                            tbLow.innerHTML = '<tr><td colspan="3" class="px-5 py-6 text-center text-slate-400">ยังไม่มีรายการเตือน</td></tr>';
                        } else {
                            tbLow.innerHTML = statsData.lowStockList.map(item => {
                                return `<tr class="hover:bg-slate-50">
                                    <td class="px-5 py-3 text-[11px] font-mono text-slate-400">#${item.id}</td>
                                    <td class="px-5 py-3 font-medium text-slate-700">${item.product_name}</td>
                                    <td class="px-5 py-3 text-right text-rose-600 font-bold">${item.total_qty}</td>
                                </tr>`;
                            }).join('');
                        }

                        // 3. Render Frequent Table
                        renderFrequentTable();

                        // 4. User/Product management actions only
                        const mgmtTypes = ['CREATE_USER', 'DELETE_USER', 'CREATE_PRODUCT', 'DELETE_PRODUCT', 'UPDATE_USER', 'UPDATE_PRODUCT'];
                        const mgmtLogs = history.filter(l => mgmtTypes.includes(l.action_type));

                        const tbody = document.getElementById('recentActivity');
                        if (mgmtLogs.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-6 text-center text-slate-400">ยังไม่มีรายการจัดการระบบ</td></tr>';
                        } else {
                            tbody.innerHTML = mgmtLogs.map(log => {
                                const rawDate = (log.action_date || '');
                                const d = new Date(rawDate.replace(' ', 'T') + '+07:00');
                                const dt = isNaN(d.getTime()) ? rawDate : d.toLocaleString('th-TH', {
                                    day: '2-digit', month: 'short',
                                    hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok'
                                });

                                let badge = '';
                                let detail = log.extra_info || log.product_name || '-';

                                if (log.action_type === 'CREATE_USER') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-700">สร้างผู้ใช้</span>';
                                } else if (log.action_type === 'DELETE_USER') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">ลบผู้ใช้</span>';
                                } else if (log.action_type === 'UPDATE_USER') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">แก้ไขผู้ใช้</span>';
                                } else if (log.action_type === 'CREATE_PRODUCT') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-violet-100 text-violet-700">เพิ่มสินค้า</span>';
                                } else if (log.action_type === 'DELETE_PRODUCT') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">ลบสินค้า</span>';
                                } else if (log.action_type === 'UPDATE_PRODUCT') {
                                    badge = '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700">แก้ไขสินค้า</span>';
                                }

                                return `<tr class="hover:bg-slate-50">
                                    <td class="px-6 py-3 text-slate-400 text-xs whitespace-nowrap">${dt}</td>
                                    <td class="px-6 py-3">${badge}</td>
                                    <td class="px-6 py-3 text-slate-800 font-medium">${detail}</td>
                                    <td class="px-6 py-3 text-slate-500">${log.actor_name || '-'}</td>
                                </tr>`;
                            }).join('');
                        }

                    } catch (e) { console.error(e); }
                }

                window.toggleFreqTab = function (tab) {
                    currentFreqTab = tab;

                    // Update buttons
                    const btnR = document.getElementById('btnFreqReceive');
                    const btnW = document.getElementById('btnFreqWithdraw');

                    if (tab === 'receive') {
                        btnR.className = "px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-blue-700 transition duration-150";
                        btnW.className = "px-3 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700 transition duration-150";
                    } else {
                        btnW.className = "px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-rose-700 transition duration-150";
                        btnR.className = "px-3 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700 transition duration-150";
                    }

                    renderFrequentTable();
                }

                function renderFrequentTable() {
                    const tbFreq = document.getElementById('tbFrequent');
                    if (!statsData) return;

                    const list = currentFreqTab === 'receive' ? statsData.frequentReceiveList : statsData.frequentWithdrawList;
                    const colorScore = currentFreqTab === 'receive' ? 'text-blue-600' : 'text-rose-600';

                    if (!list || list.length === 0) {
                        tbFreq.innerHTML = '<tr><td colspan="3" class="px-5 py-6 text-center text-slate-400">ยังไม่มีข้อมูล</td></tr>';
                    } else {
                        tbFreq.innerHTML = list.map(item => {
                            return `<tr class="hover:bg-slate-50">
                                <td class="px-5 py-3">
                                    <div class="flex items-center gap-2 font-medium text-slate-800">
                                        ${item.product_name}
                                    </div>
                                    <div class="text-[10px] text-slate-400 font-mono mt-0.5">#${item.id}</div>
                                </td>
                                <td class="px-5 py-3 text-center font-bold ${colorScore}">${item.freq}</td>
                                <td class="px-5 py-3 text-right text-slate-600 font-mono font-bold">${item.total_qty}</td>
                            </tr>`;
                        }).join('');
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    loadStats();
                });
            </script>
    </body>

</html>