<!DOCTYPE html>
<html lang="th">
<%- include('layout/head') %>

    <body class="bg-slate-50 text-slate-800 antialiased min-h-screen flex flex-col">

        <!-- Navbar -->
        <%- include('layout/navbar', { activePage: 'manage_products' , user: locals.user }) %>

            <!-- Main Content -->
            <main class="flex-grow flex flex-col items-center justify-center p-4">

                <!-- Mode Switcher -->
                <div class="mb-6 bg-white p-1 rounded-xl shadow-sm border border-slate-200 inline-flex">
                    <button id="tabAdd"
                        class="px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-emerald-600 text-white shadow-sm focus:outline-none">
                        เพิ่มสินค้าใหม่
                    </button>
                    <button id="tabDelete"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-500 hover:text-slate-800 focus:outline-none">
                        ลบสินค้า
                    </button>
                </div>

                <div
                    class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden border border-slate-100 relatiive min-h-[500px]">

                    <!-- ADD VIEW -->
                    <div id="viewAdd">
                        <div class="bg-slate-50 px-8 py-6 border-b border-slate-100 text-center">
                            <div
                                class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 mb-4 transition-transform hover:scale-110">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                            </div>
                            <h1 class="text-2xl font-bold text-slate-800">เพิ่มสินค้าใหม่</h1>
                            <p class="text-sm text-slate-500 mt-1">บันทึกข้อมูลสินค้าใหม่เข้าสู่ระบบฐานข้อมูล</p>
                        </div>

                        <form id="createProductForm" class="p-8 space-y-5">

                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-slate-700 mb-1">ชื่อสินค้า <span
                                        class="text-rose-500">*</span></label>
                                <input type="text" id="newProductName" required placeholder="เช่น นมสด ตราเต็มไขมัน"
                                    class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm transition-all"
                                    autocomplete="off">
                            </div>

                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">หมวดหมู่ <span
                                            class="text-rose-500">*</span></label>
                                    <select id="newProductCategory" required
                                        class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm bg-white transition-all cursor-pointer">
                                        <option value="" disabled selected>เลือกหมวดหมู่...</option>
                                        <option value="เนื้อสัตว์">เนื้อสัตว์</option>
                                        <option value="ผัก">ผัก</option>
                                        <option value="ผลไม้">ผลไม้</option>
                                        <option value="นม/เนย/ไข่">นม/เนย/ไข่</option>
                                        <option value="เครื่องปรุง">เครื่องปรุง</option>
                                        <option value="เครื่องดื่ม">เครื่องดื่ม</option>
                                        <option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">ราคา (บาท) <span
                                            class="text-rose-500">*</span></label>
                                    <input type="number" step="0.01" min="0" id="newProductPrice" required
                                        placeholder="0.00"
                                        class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm transition-all font-mono">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">อายุการเก็บรักษา (วัน)
                                        <span class="text-rose-500">*</span></label>
                                    <input type="number" min="1" id="newProductShelfLife" required placeholder="7"
                                        value="7"
                                        class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm transition-all font-mono">
                                </div>

                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">URL รูปภาพ</label>
                                    <input type="text" id="newProductImageUrl"
                                        placeholder="https://example.com/image.jpg"
                                        class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm transition-all font-mono text-slate-500"
                                        autocomplete="off">
                                </div>
                            </div>

                            <div class="pt-2 border-t border-slate-100 flex justify-end space-x-3 mt-8">
                                <button type="button" onclick="document.getElementById('createProductForm').reset()"
                                    class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-200">
                                    ยกเลิก
                                </button>
                                <button type="submit"
                                    class="px-5 py-2.5 bg-emerald-600 rounded-lg text-sm font-medium text-white hover:bg-emerald-700 shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                    บันทึก
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- DELETE VIEW (Initially Hidden) -->
                    <div id="viewDelete" class="hidden">
                        <div class="bg-rose-50 px-8 py-6 border-b border-rose-100 text-center">
                            <div
                                class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-white text-rose-500 mb-4 shadow-sm transition-transform hover:scale-110">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </div>
                            <h1 class="text-2xl font-bold text-rose-900">ลบสินค้าออกจากระบบ</h1>
                            <p class="text-sm text-rose-600 mt-1">ลบสินค้าและข้อมูลสต็อกที่เกี่ยวข้องทั้งหมดเป็นการถาวร
                            </p>
                        </div>

                        <div class="p-8 space-y-6">

                            <!-- Search & Select Product -->
                            <div class="relative" id="deleteSearchContainer">
                                <label
                                    class="block text-sm font-medium text-slate-700 mb-1">ค้นหาสินค้าที่ต้องการลบ</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <input type="text" id="deleteSearchInput" autocomplete="off"
                                        class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500 sm:text-sm transition-colors"
                                        placeholder="พิมพ์ชื่อสินค้า...">
                                </div>

                                <!-- Dropdown Results -->
                                <div id="deleteSearchResults"
                                    class="absolute z-10 w-full mt-1 bg-white shadow-lg max-h-60 rounded-lg overflow-y-auto border border-slate-200 hidden">
                                    <!-- Options injected here -->
                                </div>
                            </div>

                            <!-- Selected Product Info Card -->
                            <div id="selectedProductCard"
                                class="hidden relative bg-slate-50 rounded-xl p-5 border border-slate-200 space-y-4">

                                <!-- Clear Selection Button -->
                                <button type="button" id="btnClearSelection" title="ล้างการเลือก"
                                    class="absolute top-3 right-3 p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-md transition-colors focus:outline-none">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>

                                <div class="flex items-start gap-4">
                                    <div class="w-16 h-16 bg-white rounded-lg border border-slate-200 flex items-center justify-center overflow-hidden flex-shrink-0"
                                        id="selImgContainer">
                                        <!-- Image injected here -->
                                    </div>
                                    <div class="flex-grow pr-8">
                                        <h3 class="font-bold text-slate-800 text-lg leading-tight" id="selName">
                                            ชื่อสินค้า</h3>
                                        <p class="text-xs text-slate-500 mt-1 mb-2" id="selCategory">หมวดหมู่</p>
                                        <div class="flex items-center gap-3 text-sm">
                                            <span class="bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-md font-mono"
                                                id="selPrice">฿0.00</span>
                                            <span class="text-slate-500" id="selShelfLife">อายุ 0 วัน</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="bg-rose-50 text-rose-700 text-xs p-3 rounded-lg border border-rose-100 flex items-start gap-2">
                                <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p>การลบสินค้านี้จะลบข้อมูลสต็อกและประวัติที่เกี่ยวข้องออกทั้งหมด
                                    (ยกเว้นบันทึกการลบในระบบ) การกระทำนี้ไม่สามารถกู้คืนได้</p>
                            </div>

                            <button type="button" id="btnConfirmDelete" disabled
                                class="w-full py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-bold shadow-sm shadow-rose-600/20 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-rose-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                ยืนยันลบสินค้านี้
                            </button>

                        </div>
                    </div>

                </div>
            </main>

            <!-- Notification Area -->
            <div id="toastContainer" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script>
                const AUTH_USER = { username: "<%= locals.user ? locals.user.username : '' %>", role: "<%= locals.user ? locals.user.role : '' %>" };

                // --- UI Switcher ---
                const tabAdd = document.getElementById('tabAdd');
                const tabDelete = document.getElementById('tabDelete');
                const viewAdd = document.getElementById('viewAdd');
                const viewDelete = document.getElementById('viewDelete');

                tabAdd.addEventListener('click', () => {
                    tabAdd.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-emerald-600 text-white shadow-sm focus:outline-none';
                    tabDelete.className = 'px-6 py-2.5 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-500 hover:text-slate-800 focus:outline-none';
                    viewAdd.classList.remove('hidden');
                    viewDelete.classList.add('hidden');
                });

                tabDelete.addEventListener('click', () => {
                    tabDelete.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-rose-600 text-white shadow-sm focus:outline-none';
                    tabAdd.className = 'px-6 py-2.5 rounded-lg text-sm font-medium transition-all bg-transparent text-slate-500 hover:text-slate-800 focus:outline-none';
                    viewDelete.classList.remove('hidden');
                    viewAdd.classList.add('hidden');
                    fetchProductsForDelete();
                });

                // --- Add Logic ---
                document.getElementById('createProductForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const product_name = document.getElementById('newProductName').value.trim();
                    const category_name = document.getElementById('newProductCategory').value;
                    const price = parseFloat(document.getElementById('newProductPrice').value);
                    const shelf_life_days = parseInt(document.getElementById('newProductShelfLife').value, 10);
                    const image_url = document.getElementById('newProductImageUrl').value.trim();

                    try {
                        const res = await fetch('/api/admin/products', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_name, category_name, price, shelf_life_days, image_url })
                        });
                        const result = await res.json();

                        if (res.ok) {
                            Swal.fire({
                                title: 'สำเร็จ!',
                                text: 'บันทึกข้อมูลสินค้าใหม่เรียบร้อยแล้ว',
                                icon: 'success',
                                confirmButtonColor: '#059669' // emerald-600
                            }).then(() => {
                                document.getElementById('createProductForm').reset();
                                masterDeleteProducts = []; // invalidate cache
                            });
                        } else {
                            Swal.fire({
                                title: 'ล้มเหลว',
                                text: result.error,
                                icon: 'error',
                                confirmButtonColor: '#059669' // emerald-600
                            });
                        }
                    } catch (err) {
                        Swal.fire('ข้อผิดพลาด', 'ระบบขัดข้อง กรุณาลองใหม่', 'error');
                    }
                });

                // --- Delete Logic ---
                let masterDeleteProducts = [];
                let currentSelectedProduct = null;
                const searchInput = document.getElementById('deleteSearchInput');
                const searchResults = document.getElementById('deleteSearchResults');
                const productCard = document.getElementById('selectedProductCard');

                async function fetchProductsForDelete() {
                    if (masterDeleteProducts.length > 0) return; // avoid refetch
                    try {
                        const res = await fetch('/api/admin/products');
                        masterDeleteProducts = await res.json();
                        renderDeleteSearchOptions(masterDeleteProducts);
                    } catch (e) {
                        console.error('Failed to fetch products for delete list');
                    }
                }

                function renderDeleteSearchOptions(products) {
                    searchResults.innerHTML = '';
                    if (products.length === 0) {
                        searchResults.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">ไม่พบสินค้า</div>';
                        return;
                    }

                    products.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-3 hover:bg-rose-50 cursor-pointer transition-colors border-b border-slate-50 last:border-0 flex items-center justify-between';
                        div.innerHTML = `
                            <span class="text-sm font-medium text-slate-700">${p.product_name}</span>
                            <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded">${p.category_name}</span>
                        `;
                        div.addEventListener('click', () => {
                            selectProductForDelete(p);
                        });
                        searchResults.appendChild(div);
                    });
                }

                function selectProductForDelete(product) {
                    currentSelectedProduct = product;
                    searchInput.value = product.product_name;
                    searchResults.classList.add('hidden');

                    // Populate Card
                    document.getElementById('selName').textContent = product.product_name;
                    document.getElementById('selCategory').textContent = product.category_name;
                    document.getElementById('selPrice').textContent = `฿${(product.price || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                    document.getElementById('selShelfLife').textContent = `อายุเก็บรักษา ${product.shelf_life_days} วัน`;

                    const imgNode = document.getElementById('selImgContainer');
                    if (product.image_url) {
                        imgNode.innerHTML = `<img src="${product.image_url}" alt="${product.product_name}" class="w-full h-full object-cover">`;
                    } else {
                        imgNode.innerHTML = `<svg class="w-6 h-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L28 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
                    }

                    productCard.classList.remove('hidden');
                    document.getElementById('btnConfirmDelete').disabled = false;
                }

                document.getElementById('btnClearSelection').addEventListener('click', () => {
                    currentSelectedProduct = null;
                    searchInput.value = '';
                    productCard.classList.add('hidden');
                    document.getElementById('btnConfirmDelete').disabled = true;
                });

                searchInput.addEventListener('focus', () => {
                    if (masterDeleteProducts.length > 0) {
                        renderDeleteSearchOptions(masterDeleteProducts);
                        searchResults.classList.remove('hidden');
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    currentSelectedProduct = null;
                    productCard.classList.add('hidden');
                    document.getElementById('btnConfirmDelete').disabled = true;

                    const filtered = masterDeleteProducts.filter(p => p.product_name.toLowerCase().includes(val));
                    renderDeleteSearchOptions(filtered);
                    searchResults.classList.remove('hidden');
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#deleteSearchContainer')) {
                        searchResults.classList.add('hidden');
                    }
                });

                document.getElementById('btnConfirmDelete').addEventListener('click', () => {
                    if (!currentSelectedProduct) return;

                    Swal.fire({
                        title: 'ยืนยันการลบสินค้า?',
                        html: `คุณกำลังจะลบ <b>${currentSelectedProduct.product_name}</b><br><span class="text-sm text-rose-500">การกระทำนี้รวมถึงสต็อกของสินค้าตัวนี้ทั้งหมด และไม่สามารถกู้คืนได้</span>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#e11d48', // rose-600
                        cancelButtonColor: '#94a3b8', // slate-400
                        confirmButtonText: 'ลบข้อมูล',
                        cancelButtonText: 'ยกเลิก',
                        reverseButtons: true
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                const res = await fetch(`/api/admin/products/${currentSelectedProduct.id}`, {
                                    method: 'DELETE'
                                });
                                const data = await res.json();

                                if (res.ok) {
                                    Swal.fire(
                                        'ลบสำเร็จ!',
                                        'ลบสินค้าเรียบร้อยแล้ว',
                                        'success'
                                    );
                                    // Reset UI
                                    productCard.classList.add('hidden');
                                    searchInput.value = '';
                                    document.getElementById('btnConfirmDelete').disabled = true;
                                    masterDeleteProducts = masterDeleteProducts.filter(p => p.id !== currentSelectedProduct.id);
                                    currentSelectedProduct = null;
                                } else {
                                    Swal.fire('ล้มเหลว', data.error || 'ไม่สามารถลบสินค้าได้', 'error');
                                }
                            } catch (err) {
                                Swal.fire('ข้อผิดพลาด', 'ระบบขัดข้อง', 'error');
                            }
                        }
                    });
                });

            </script>
            <script src="/js/main.js"></script>
    </body>

</html>